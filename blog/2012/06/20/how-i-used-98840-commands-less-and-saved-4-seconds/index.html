
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>How I used 98840 commands less and saved 4 seconds - Written by Thorsten Ball</title>
  <meta name="author" content="Thorsten Ball">

  
  <meta name="description" content="In my last post I explained how to implement a search autocompletion backend
using Redis. This week I used the described implementation with its &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mrnugget.github.com/blog/2012/06/20/how-i-used-98840-commands-less-and-saved-4-seconds/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Written by Thorsten Ball" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32543112-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Written by Thorsten Ball</a></h1>
  
</hgroup>

</header>
  <nav role="navigation">  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Posts</a></li>
  <li><a href="http://www.github.com/mrnugget">Github</a></li>
  <li><a href="http://www.twitter.com/herrbrocken">Twitter</a></li>
</ul>
<ul class="subscription">
  <li><a href="/atom.xml" alt="Subscribe to the RSS feed">RSS</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">How I Used 98840 Commands Less and Saved 4 Seconds</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-20T18:58:00+02:00" pubdate data-updated="true">Jun 20<span>th</span>, 2012</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>In my last post I explained how to implement a search autocompletion backend
using Redis. This week I used the described implementation with its <code>add_movie</code> method to put thousands of movies into my Redis database
in order to use them for the autocompletion on
<a href="http://anygood.heroku.com" title="AnyGood - Check if a movie was
any good!">anygood.heroku.com</a>. It&#8217;s the same method as described in the last post, but with
important change I didn&#8217;t think about too much: I did not overwrite the score of the members in the sorted
sets. The method I used for adding movies looked like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">add_movie</span><span class="p">(</span><span class="n">movie_hash</span><span class="p">)</span>
</span><span class='line'>  <span class="n">prefixes</span>    <span class="o">=</span> <span class="n">prefixes_for</span><span class="p">(</span><span class="n">movie_hash</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="n">hashed_name</span> <span class="o">=</span> <span class="n">data_hash_key_for</span><span class="p">(</span><span class="n">movie_hash</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>    <span class="n">score</span> <span class="o">=</span> <span class="no">REDIS</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">index_key_for</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span> <span class="n">hashed_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="o">||</span> <span class="mi">0</span>
</span><span class='line'>    <span class="no">REDIS</span><span class="o">.</span><span class="n">zadd</span><span class="p">(</span><span class="n">index_key_for</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span> <span class="n">score</span><span class="p">,</span> <span class="n">hashed_name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">REDIS</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">data_key</span><span class="p">,</span> <span class="n">hashed_name</span><span class="p">,</span> <span class="n">movie_hash</span><span class="o">.</span><span class="n">to_json</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding movies took suspiciously long, longer than I thought it would.
Looking at it now it&#8217;s pretty easy to tell why: it was exactly that small change
that lowered the speed of my importing process, I <em>did</em> cache the member score
in <em>every</em> prefix set and then used in the <code>REDIS.zadd</code> line. Every time a movie
was added, for each of its prefixes the score of the correspondent sorted set
member was saved and used again. That&#8217;s not bad at all, no, it didn&#8217;t slip in
there either! Heck, I wrote tests for this. But looking at the code I concluded
that it was not a feature I needed. Using the code above, every movie would have
a different rank in the autocomplete output according to the user input. One
movie could be ranked higher when the user typed in <em>the</em> and ranked lower when
the input was <em>dark</em>. That is pretty cool, but I wanted a different behaviour:
the sorted set members associated with one movie should have one score, the same
one in every set. And after running some benchmarks I found out how implementing
the wrong behaviour slowed me down.</p>

<!-- more -->


<p>Testing this was simple: I wrote a small script that allowed me to add ten
thousand movies with the aforementioned method. The rest is just a shell and
<code>time</code>. The script looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby -wKU</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;redis&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;digest&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">REDIS</span> <span class="o">=</span> <span class="no">Redis</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># We need to generate the prefixes for every moviename</span>
</span><span class='line'><span class="k">def</span> <span class="nf">prefixes_for</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span class='line'>  <span class="n">prefixes</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="n">words</span>    <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">downcase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">words</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
</span><span class='line'>    <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.word</span><span class="o">.</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">prefixes</span> <span class="o">&lt;&lt;</span> <span class="n">word</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">i</span><span class="o">]</span> <span class="k">unless</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">prefixes</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Adding 10000 movies</span>
</span><span class='line'><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">10000</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="n">movie_name</span>  <span class="o">=</span> <span class="s2">&quot;The Number</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="n">hashed_name</span> <span class="o">=</span> <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'>  <span class="n">prefixes</span>    <span class="o">=</span> <span class="n">prefixes_for</span><span class="p">(</span><span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>    <span class="n">score</span> <span class="o">=</span> <span class="no">REDIS</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="o">||</span> <span class="mi">0</span>
</span><span class='line'>    <span class="no">REDIS</span><span class="o">.</span><span class="n">zadd</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">REDIS</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s2">&quot;testing:redis:data:Number</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">,</span> <span class="s2">&quot;This is Number </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s a good idea to delete all keys in our instance (using <code>FLUSHALL</code>) before
running this script and monitoring is especially and always great: Redis&#8217; handy
<code>MONITOR</code> command outputs all the commands our instance receives, complete
with timestamp. So, monitoring our instance in the background, its time to see
how often <code>ZSCORE</code> gets called when we add those ten thousand movies:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>redis-cli FLUSHALL
</span><span class='line'>OK
</span><span class='line'><span class="nv">$ </span>redis-cli MONITOR | grep zscore &gt; zscore_for_every_prefix.txt &amp;
</span><span class='line'><span class="o">[</span>1<span class="o">]</span> 94937 94938
</span><span class='line'><span class="nv">$ </span>ruby insert_10000_movies.rb
</span><span class='line'><span class="nv">$ </span><span class="nb">fg</span>
</span><span class='line'><span class="o">[</span>1<span class="o">]</span>  + 94937 running    redis-cli MONITOR |
</span><span class='line'>       94938 running    grep zscore &gt; zscore_for_every_prefix.txt
</span><span class='line'>^C
</span><span class='line'><span class="nv">$ </span>wc -l zscore_for_every_prefix.txt
</span><span class='line'>  108840 zscore_for_every_prefix.txt
</span></code></pre></td></tr></table></div></figure>


<h2>Use less commands!</h2>

<p>That is a huge number. But don&#8217;t you worry, lowering it is pretty easy. Just
change a couple of lines of <code>insert_10000_movies.rb</code> to get the behaviour we
want and it looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># [...]</span>
</span><span class='line'><span class="n">score</span> <span class="o">=</span> <span class="no">REDIS</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefixes</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="o">||</span> <span class="mi">0</span>
</span><span class='line'><span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>  <span class="no">REDIS</span><span class="o">.</span><span class="n">zadd</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># [...]</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this in place, <code>ZSCORE</code> will get called exactly one time for each movie and
not for every prefix of every movie. Instead of using <code>ZSCORE</code> 108840 times,
after that small change it only gets called ten thousand times.  And 108840
minus 10000 is <em>98840</em>. That&#8217;s <em>98840 commands</em> less!</p>

<p>But let&#8217;s not stop here. On my MacBook Air it took roughly <em>7</em> seconds to insert
those ten thousand movies using <code>ZSCORE</code> on every prefix. With <em>98840</em>
commands less it only takes around <em>4</em>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>redis-cli FLUSHALL
</span><span class='line'>OK
</span><span class='line'><span class="nv">$ </span><span class="nb">time </span>ruby insert_10000_movies.rb
</span><span class='line'>ruby insert_10000_movies.rb  7.39s user 3.78s system 54% cpu 20.448 total
</span><span class='line'><span class="nv">$ </span>redis-cli FLUSHALL
</span><span class='line'>OK
</span><span class='line'><span class="nv">$ </span><span class="nb">time </span>ruby insert_10000_with_one_prefix_score.rb
</span><span class='line'>ruby insert_10000_movies_with_one_prefix.rb  4.42s user 2.19s system 54% cpu 12.112 total
</span></code></pre></td></tr></table></div></figure>


<h2>Redis and the Pipeline</h2>

<p>I wasn&#8217;t satisfied with this result and while examining the code again I
remembered <a href="http://www.redis.io/topics/pipelining" title="Redis pipelining documentation">Redis pipelining abilities.</a></p>

<p>When sending requests to Redis using pipelining the server doesn&#8217;t wait
for the client (our code) to progress its responses, it just accepts them and
does as it&#8217;s told. And the client doesn&#8217;t read any responses, it just fires
the next request until all commands in the pipeline are sent.
<a href="https://github.com/redis/redis-rb" title="redis-rb">redis-rb</a> fully supports
pipelining to Redis and using it is pretty straightforward: Just put the part of your code
that&#8217;s sending requests to Redis into a <code>REDIS.pipelined</code> block and everything
in the block will be going through the pipeline. That should save us some
seconds, right? Time to make a use of it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># [...]</span>
</span><span class='line'><span class="n">score</span> <span class="o">=</span> <span class="no">REDIS</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefixes</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span> <span class="o">||</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="no">REDIS</span><span class="o">.</span><span class="n">pipelined</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>    <span class="no">REDIS</span><span class="o">.</span><span class="n">zadd</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">REDIS</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="s2">&quot;testing:redis:data:Number</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">,</span> <span class="s2">&quot;This is Number </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># [...]</span>
</span></code></pre></td></tr></table></div></figure>


<p>What we&#8217;re doing here is precisely what I just described: for each movie we open
a pipeline to Redis and send all the <code>ZADD</code> and finally the <code>HSET</code> command
straight to Redis without blinking an eye. The response won&#8217;t get processed
until the block is finished. Doing that our script runs noticeably
faster. But since we all love benchmarking, hard numbers and speed, let&#8217;s see
how fast exactly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>redis-cli FLUSHALL
</span><span class='line'>OK
</span><span class='line'><span class="nv">$ </span><span class="nb">time </span>ruby insert_10000_movies_pipelined.rb
</span><span class='line'>ruby insert_10000_movies_optimized.rb  3.42s user 1.26s system 86% cpu 5.414 total
</span></code></pre></td></tr></table></div></figure>


<p><em>4</em> seconds less! That is more than 50% faster! Wow! This is great, this is
magnificient! Let&#8217;s pipeline all the commands!</p>

<h2>Not so fast, buddy!</h2>

<p>Woah, easy, buddy, hold it right there! Let me tell you something: It would be
great if we could put all our Redis interactions within a <code>REDIS.pipeline</code>
block, but there is one small problem. As I said, the server doesn&#8217;t wait for
the client to process its responses and the client waits until the pipeline is
empty. That means you can&#8217;t pipeline blocks of code in which you work
with the servers response. The code at the beginning of this article did use
the server&#8217;s responses, remember? We used <code>ZSCORE</code> for every prefix to get the score
of the member in that particular set, saved it and then updated the member of the
set with exactly that score. That&#8217;s not possible when sending our orders through
the pipeline.</p>

<p>I guess an example should clear things up so let&#8217;s add a couple of movies with
the following code, resulting in every member of every index set having a score
of 10:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">REDIS</span><span class="o">.</span><span class="n">pipelined</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>    <span class="no">REDIS</span><span class="o">.</span><span class="n">zadd</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using <code>redis-cli MONITOR</code> in a parallel shell session, we can see what&#8217;s being
sent to Redis:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[.</span><span class="n">.</span><span class="o">.]</span>
</span><span class='line'><span class="mi">1341173848</span><span class="o">.</span><span class="mi">796741</span> <span class="s2">&quot;zadd&quot;</span> <span class="s2">&quot;testing:redis:index:number1000&quot;</span> <span class="s2">&quot;10&quot;</span> <span class="s2">&quot;The Number10000&quot;</span>
</span><span class='line'><span class="mi">1341173848</span><span class="o">.</span><span class="mi">796772</span> <span class="s2">&quot;zadd&quot;</span> <span class="s2">&quot;testing:redis:index:number10000&quot;</span> <span class="s2">&quot;10&quot;</span> <span class="s2">&quot;The Number10000&quot;</span>
</span><span class='line'><span class="mi">1341173848</span><span class="o">.</span><span class="mi">796923</span> <span class="s2">&quot;hset&quot;</span> <span class="s2">&quot;testing:redis:data:Number10000&quot;</span> <span class="s2">&quot;The Number10000&quot;</span> <span class="s2">&quot;This is Number 10000&quot;</span>
</span><span class='line'><span class="o">[.</span><span class="n">.</span><span class="o">.]</span>
</span></code></pre></td></tr></table></div></figure>


<p>That looks fine. Now, if we were to add those movies again (with the keys still in our Redis
instance), and try to cache the scores inside a <code>pipeline</code> block, it won&#8217;t
work, since the client doesn&#8217;t process the servers response until after the
pipelining block is finished. The following change in the code will show when
the response is there and when it isn&#8217;t:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">scores</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="n">scores</span> <span class="o">&lt;&lt;</span> <span class="no">REDIS</span><span class="o">.</span><span class="n">pipelined</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>    <span class="n">scores</span> <span class="o">&lt;&lt;</span> <span class="no">REDIS</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="n">scores</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will output the following for each movie:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The servers responses are only there (the last element in the <code>scores</code> array)
after the block is finished, inside the block the <code>scores</code> array is filled with
<code>nil</code>s: no response has been read yet. Using nearly the same code but
<em>without pipelining</em> we get totally different results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">scores</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'><span class="n">prefixes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prefix</span><span class="o">|</span>
</span><span class='line'>  <span class="n">scores</span> <span class="o">&lt;&lt;</span> <span class="no">REDIS</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="s2">&quot;testing:redis:index:</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">movie_name</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">scores</span><span class="o">.</span><span class="n">inspect</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">scores</span><span class="o">.</span><span class="n">inspect</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span><span class='line'><span class="o">[</span><span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see now that pipelining is a great way to gain speed when progressing huge lists
of commands, which is exactly what I was after when adding thousands and
thousands of movies, but when you need to work with the servers response, say
when getting a value and using that value in another request, the value just
won&#8217;t be there inside a pipelining block, only after it finished executing.
Pipelining is a great thing to know, but only when the requirements are right
and it&#8217;s applicable.</p>

<p>That means I used 98840 commands less by adjusting the code for its use case and
saved 4 seconds using the right tool for the job, which is always great, isn&#8217;t
it?</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Thorsten Ball</span></span>

      








  


<time datetime="2012-06-20T18:58:00+02:00" pubdate data-updated="true">Jun 20<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mrnugget.github.com/blog/2012/06/20/how-i-used-98840-commands-less-and-saved-4-seconds/" data-via="thorstenball" data-counturl="http://mrnugget.github.com/blog/2012/06/20/how-i-used-98840-commands-less-and-saved-4-seconds/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/06/08/search-autocompletion-with-redis/" title="Previous Post: Ordered Search Autocompletion With Redis">&laquo; Ordered Search Autocompletion With Redis</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/07/09/vim-learning-resources/" title="Next Post: Vim Learning Resources">Vim Learning Resources &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section class="about">
  <h1>About Me</h1>
  <img src="/images/avatar.jpg">
  <p>I'm 24 years old, living in Berlin, Germany and I want to write about
  things that I'm interested in: Ruby, Ruby on Rails, Web Development, Music and
  Guitars!</p>
  <p>I'm currently doing an internship programming Ruby and developing web
  applications with Ruby on Rails.</p>
  <p>If you want to contact me via e-mail: <a href="http://www.github.com/mrnugget">my github username</a>
  at gmail.com</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/07/09/vim-learning-resources/">Vim Learning Resources</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/20/how-i-used-98840-commands-less-and-saved-4-seconds/">How I used 98840 commands less and saved 4 seconds</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/08/search-autocompletion-with-redis/">Ordered Search Autocompletion With Redis</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("thorstenball", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/thorstenball" class="twitter-follow-button" data-show-count="false">Follow @thorstenball</a>
  
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Thorsten Ball
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'writtenbythorstenball';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://mrnugget.github.com/blog/2012/06/20/how-i-used-98840-commands-less-and-saved-4-seconds/';
        var disqus_url = 'http://mrnugget.github.com/blog/2012/06/20/how-i-used-98840-commands-less-and-saved-4-seconds/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
